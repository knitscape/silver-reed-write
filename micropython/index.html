<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SK840 Pin Monitor</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "SF Mono", "Fira Code", monospace;
        background: #0a0a0f;
        color: #e0e0e0;
        min-height: 100vh;
        margin: 0;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 400;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #888;
        margin-bottom: 40px;
      }

      h2 {
        font-size: 1rem;
        font-weight: 400;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #666;
        margin-top: 50px;
        margin-bottom: 20px;
      }

      .connect-btn {
        background: transparent;
        border: 1px solid #444;
        color: #aaa;
        padding: 12px 32px;
        font-family: inherit;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 50px;
      }

      .connect-btn:hover {
        border-color: #888;
        color: #fff;
      }

      .connect-btn.connected {
        border-color: #2ecc71;
        color: #2ecc71;
      }

      .pins {
        display: flex;
        gap: 60px;
      }

      .pin {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .pin-indicator {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #1a1a24;
        border: 3px solid #333;
        transition: all 0.1s;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
      }

      .pin-indicator.on {
        box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.1),
          0 0 40px var(--glow-color), 0 0 80px var(--glow-color);
      }

      .pin.nd1 .pin-indicator {
        --glow-color: rgba(241, 196, 15, 0.6);
      }
      .pin.nd1 .pin-indicator.on {
        background: #f1c40f;
        border-color: #d4ac0d;
      }

      .pin.cams .pin-indicator {
        --glow-color: rgba(46, 204, 113, 0.6);
      }
      .pin.cams .pin-indicator.on {
        background: #2ecc71;
        border-color: #27ae60;
      }

      .pin.clock .pin-indicator {
        --glow-color: rgba(52, 152, 219, 0.6);
      }
      .pin.clock .pin-indicator.on {
        background: #3498db;
        border-color: #2980b9;
      }

      .pin.direction .pin-indicator {
        --glow-color: rgba(155, 89, 182, 0.6);
      }
      .pin.direction .pin-indicator.on {
        background: #9b59b6;
        border-color: #8e44ad;
      }

      .pin-label {
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: #666;
      }

      .pin-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #444;
        transition: color 0.1s;
      }

      .pin-value.on {
        color: #fff;
      }

      .status {
        margin-top: 50px;
        font-size: 0.8rem;
        color: #444;
      }

      .test-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        max-width: 600px;
      }

      .test-btn {
        background: transparent;
        border: 1px solid #333;
        color: #888;
        padding: 10px 20px;
        font-family: inherit;
        font-size: 0.8rem;
        letter-spacing: 0.03em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .test-btn:hover {
        border-color: #e74c3c;
        color: #e74c3c;
      }

      .test-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .row-preview {
        margin-top: 20px;
        padding: 15px;
        background: #12121a;
        border-radius: 8px;
        font-size: 0.75rem;
        color: #666;
        max-width: 600px;
        word-break: break-all;
      }

      .row-preview .label {
        color: #888;
        margin-bottom: 8px;
      }

      .row-preview .pattern {
        font-family: monospace;
        color: #3498db;
      }
    </style>
  </head>
  <body>
    <h1>SK840 Pin Monitor</h1>

    <button class="connect-btn" id="connectBtn">Connect</button>

    <div class="pins">
      <div class="pin nd1">
        <div class="pin-indicator" id="nd1Indicator"></div>
        <div class="pin-label">ND1</div>
        <div class="pin-value" id="nd1Value">-</div>
      </div>

      <div class="pin cams">
        <div class="pin-indicator" id="camsIndicator"></div>
        <div class="pin-label">CAMS</div>
        <div class="pin-value" id="camsValue">-</div>
      </div>

      <div class="pin clock">
        <div class="pin-indicator" id="clockIndicator"></div>
        <div class="pin-label">Clock Pulse</div>
        <div class="pin-value" id="clockValue">-</div>
      </div>

      <div class="pin direction">
        <div class="pin-indicator" id="dirIndicator"></div>
        <div class="pin-label">Direction</div>
        <div class="pin-value" id="dirValue">-</div>
      </div>
    </div>

    <h2>Test Row Patterns</h2>

    <div class="test-buttons">
      <button class="test-btn" id="btnAllOn" disabled>All On</button>
      <button class="test-btn" id="btnAllOff" disabled>All Off</button>
      <button class="test-btn" id="btnAlternate" disabled>Alternating</button>
      <button class="test-btn" id="btnChunks" disabled>Chunks of 4</button>
      <button class="test-btn" id="btnGradient" disabled>Random</button>
    </div>

    <div class="row-preview">
      <div class="label">Last sent pattern:</div>
      <div class="pattern" id="patternPreview">-</div>
    </div>

    <div class="status" id="status">Disconnected</div>

    <script>
      const MSG_PINS = 0x01;
      const CMD_SET_ROW = 0x02;

      let port = null;
      let reader = null;
      let readBuffer = new Uint8Array(0);

      const connectBtn = document.getElementById("connectBtn");
      const statusDiv = document.getElementById("status");
      const patternPreview = document.getElementById("patternPreview");

      const nd1Indicator = document.getElementById("nd1Indicator");
      const camsIndicator = document.getElementById("camsIndicator");
      const clockIndicator = document.getElementById("clockIndicator");
      const dirIndicator = document.getElementById("dirIndicator");
      const nd1Value = document.getElementById("nd1Value");
      const camsValue = document.getElementById("camsValue");
      const clockValue = document.getElementById("clockValue");
      const dirValue = document.getElementById("dirValue");

      const testButtons = document.querySelectorAll(".test-btn");

      function sendRow(pattern) {
        if (!port || !port.writable) return;

        // pattern is an array of 0s and 1s
        const length = pattern.length;
        if (length > 200) {
          console.error("Row too long, max 200");
          return;
        }

        // Build message: [CMD_SET_ROW, length, ...pattern]
        const msg = new Uint8Array(2 + length);
        msg[0] = CMD_SET_ROW;
        msg[1] = length;
        msg.set(pattern, 2);

        const writer = port.writable.getWriter();
        writer
          .write(msg)
          .then(() => {
            writer.releaseLock();
            patternPreview.textContent = pattern.join("");
          })
          .catch((err) => {
            console.error("Write error:", err);
            writer.releaseLock();
          });
      }

      function updatePins(state) {
        const nd1 = state & 0x01;
        const cams = (state >> 1) & 0x01;
        const clock = (state >> 2) & 0x01;
        const dir = (state >> 3) & 0x01;

        nd1Indicator.classList.toggle("on", nd1 === 1);
        camsIndicator.classList.toggle("on", cams === 1);
        clockIndicator.classList.toggle("on", clock === 1);
        dirIndicator.classList.toggle("on", dir === 1);

        nd1Value.textContent = nd1;
        camsValue.textContent = cams;
        clockValue.textContent = clock;
        dirValue.textContent = dir === 1 ? "← L" : "R →";

        nd1Value.classList.toggle("on", nd1 === 1);
        camsValue.classList.toggle("on", cams === 1);
        clockValue.classList.toggle("on", clock === 1);
        dirValue.classList.toggle("on", dir === 1);
      }

      async function readLoop() {
        if (!port || !port.readable) return;

        reader = port.readable.getReader();

        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            // Append to buffer
            const newBuffer = new Uint8Array(readBuffer.length + value.length);
            newBuffer.set(readBuffer);
            newBuffer.set(value, readBuffer.length);
            readBuffer = newBuffer;

            // Process messages (2 bytes each: MSG_PINS + state)
            while (readBuffer.length >= 2) {
              if (readBuffer[0] === MSG_PINS) {
                updatePins(readBuffer[1]);
                readBuffer = readBuffer.slice(2);
              } else {
                // Unknown, skip byte
                readBuffer = readBuffer.slice(1);
              }
            }
          }
        } catch (error) {
          console.error("Read error:", error);
        } finally {
          if (reader) reader.releaseLock();
        }

        handleDisconnect();
      }

      function setButtonsEnabled(enabled) {
        testButtons.forEach((btn) => (btn.disabled = !enabled));
      }

      function handleDisconnect() {
        connectBtn.textContent = "Connect";
        connectBtn.classList.remove("connected");
        statusDiv.textContent = "Disconnected";
        setButtonsEnabled(false);
        port = null;
        reader = null;
      }

      async function connect() {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          connectBtn.textContent = "Connected";
          connectBtn.classList.add("connected");
          statusDiv.textContent = "Receiving data...";
          setButtonsEnabled(true);

          readBuffer = new Uint8Array(0);
          readLoop();
        } catch (error) {
          console.error("Connection error:", error);
          statusDiv.textContent = "Connection failed: " + error.message;
        }
      }

      async function disconnect() {
        if (reader) {
          try {
            await reader.cancel();
          } catch (e) {}
          reader = null;
        }
        if (port) {
          try {
            await port.close();
          } catch (e) {}
          port = null;
        }
        handleDisconnect();
      }

      connectBtn.addEventListener("click", () => {
        if (port) {
          disconnect();
        } else {
          connect();
        }
      });

      // Test button handlers - all 30 needles
      document.getElementById("btnAllOn").addEventListener("click", () => {
        sendRow(new Array(30).fill(1));
      });

      document.getElementById("btnAllOff").addEventListener("click", () => {
        sendRow(new Array(30).fill(0));
      });

      document.getElementById("btnAlternate").addEventListener("click", () => {
        const pattern = [];
        for (let i = 0; i < 30; i++) {
          pattern.push(i % 2);
        }
        sendRow(pattern);
      });

      document.getElementById("btnChunks").addEventListener("click", () => {
        const pattern = [];
        for (let i = 0; i < 30; i++) {
          pattern.push(Math.floor(i / 4) % 2);
        }
        sendRow(pattern);
      });

      document.getElementById("btnGradient").addEventListener("click", () => {
        const pattern = [];
        for (let i = 0; i < 30; i++) {
          pattern.push(Math.random() < 0.5 ? 1 : 0);
        }
        sendRow(pattern);
      });
    </script>
  </body>
</html>
